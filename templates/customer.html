<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seller page</title>
    <script type="text/javascript" src="{{ url_for('static', filename='web3.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='abi.js') }}"></script>
</head>
<body>
    <h1>Hello {{user.fio}}!</h1>
    <h4 id="balance"></h4>
    <table>
        <thead>
            <tr>
                <th>№ магазина</th>
                <th>№ товара</th>
                <th>Наименование</th>
                <th>Ед. измерения</th>
                <th>Цена</th>
                <th>Количество</th>
                <th>Купить</th>
                <th>Оценить</th>
            </tr>
        </thead>
        <tbody id="items">
        </tbody>
    </table>
    <div id="test"></div>
</body>
<script>
  let contractAdr = '0x90386b336BFd4E5fd11DE6B2F9B51B09d69a379B';
    let web3 = new Web3('http://localhost:7545')
    let contract = undefined;
    let account = undefined;
    let units = undefined;
    let items = {};

    function GetTD(name)
    {
        let td = document.createElement("td");
        td.innerHTML = name;
        return td;
    }

    function CreateButton(name, click_func, shop, index)
    {
        let inp = document.createElement("input");
        inp.type = "text";
        inp.value = "1";
        inp.style = "width: 30px;"
        inp.id = "inp" + shop + '-' + index;
        let b = document.createElement("button");
        b.innerHTML=name;
        b.id = shop + '-' + index;
        b.onclick = click_func;
        td = document.createElement("td");
        td.appendChild(inp);
        td.appendChild(b);
        return td;
    }

    function BuyItemClick(event)
    {
        console.log("Buy click");
        let a = event.target.id.split('-');
        console.log(a[0]);
        console.log(a[1]);
        let inp = document.getElementById("inp" + event.target.id);
        let amount = parseInt(inp.value);
        let item_index = parseInt(a[1])-1;
        contract.methods.BuyItem(a[0], item_index, amount)
            .send({"from":account, "gas":3000000, "value": (BigInt(items[a[0]][item_index].price)*BigInt(amount)).toString()})
            .on('receipt', receipt=>{
                alert("Товар успешно куплен!");
            })
            .on('error', (error, receipt)=>{
                alert(error);
            })
    }

    function GradeItemClick(event)
    {
        console.log("Grade click");
        let a = event.target.id.split('-');
        console.log(a[0]);
        console.log(a[1]);
    }

    function GetRow(item, index, shopname, shop_acc)
    {
        let tr = document.createElement("tr");
        tr.appendChild(GetTD(shopname));
        tr.appendChild(GetTD(index.toString()));
        tr.appendChild(GetTD(item['name']));
        tr.appendChild(GetTD(units[item['unit']]));
        tr.appendChild(GetTD(web3.utils.fromWei(item['price'], 'ether') + "eth"));
        tr.appendChild(GetTD(item['amount']));
        tr.appendChild(CreateButton("Купить", BuyItemClick, shop_acc, index));
        tr.appendChild(CreateButton("Оценить", GradeItemClick, shop_acc, index));
        return tr;
    }

    window.onload = (e) => {
        contract = new web3.eth.Contract(abi, contractAdr);
        ethereum.request({'method':'eth_requestAccounts'})
        .then(accounts=>{
            account = accounts[0];
            web3.eth.getBalance(account).then(balance=>{
                let h = document.getElementById("balance");
                let bal = web3.utils.fromWei(balance, 'ether');
                h.innerHTML = "У вас " + bal.slice(0, bal.indexOf('.')+5) + " ether";
            });
        });

        contract.methods.GetShops().call()
        .then(data=>{
            console.log(data);
            data.forEach((element, shop_index)=>{
                contract.methods.GetItems(element.account).call()
                .then(data=>{
                    items[element.account] = data;
                    console.log(data);
                    tbody = document.getElementById("items");
                    data.forEach((item, index) => {
                        let row = GetRow(item, index+1, (shop_index+1).toString(), element.account);
                        tbody.appendChild(row);
                    });
                })
                .catch(error=>{ alert(error); })
            })
        })
        .catch(error=>{
            alert(error);
        });

        contract.methods.GetUnits().call()
        .then(data=>{ units = data; })
        .catch(error=>{ alert(error); });
    }
</script>
</html>
